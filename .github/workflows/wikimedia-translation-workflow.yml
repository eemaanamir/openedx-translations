name: Wikimedia Translation Workflow

on:
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream branch for Atlas pull'
        required: true
        default: 'release/teak'

jobs:
  # STEP 1: Upstream Pull (Atlas)
  pull-upstream:
    runs-on: ubuntu-latest
    outputs:
      langs: ${{ steps.get-langs.outputs.langs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install openedx-atlas polib

      - name: STEP 1 Atlas Pull Upstream
        run: |
          # Create dir
          mkdir -p translations-upstream
          # Run atlas pull using the provided revision (-n)
          # We pull the 'translations' directory from openedx/openedx-translations
          # the -g (expand-glob) ensures we get all subdirectories.
          atlas pull -n ${{ inputs.upstream_branch }} -g translations:translations-upstream

          # Verify pull
          ls -R translations-upstream/ | head -n 20

      - name: Upload Upstream Artifact
        uses: actions/upload-artifact@v4
        with:
          name: translations-upstream
          path: translations-upstream/

  # STEP 2: Selective Extraction (Custom Repos)
  # We reuse the matrix generation logic but filtered for custom
  setup-extraction-matrix:
    runs-on: ubuntu-latest
    outputs:
      python_repos: ${{ steps.generate.outputs.python_repos }}
      js_repos: ${{ steps.generate.outputs.js_repos }}
      generic_repos: ${{ steps.generate.outputs.generic_repos }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        id: generate
        with:
          script: |
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('.github/wikilearn-repos-config.json', 'utf8'));

            const python = [];
            const js = [];
            const generic = [];

            ['python', 'javascript', 'generic'].forEach(type => {
              (config.custom_repos[type] || []).forEach(repo => {
                if (repo.new_repo || repo.replaces_default) {
                  const item = {
                    name: repo.default_repo_name || repo.repo,
                    actualName: repo.repo,
                    organization: repo.organization,
                    ref: repo.branch,
                    type: type
                  };
                  if (type === 'python') python.push(item);
                  if (type === 'javascript') js.push(item);
                  if (type === 'generic') {
                    // Pass full config for generic repos
                    generic.push({
                      ...item,
                      transifex_file_path: repo.transifex_file_path || 'conf/locale/en/LC_MESSAGES/django.po',
                      extraction_method: repo.extraction_method || 'django'
                    });
                  }
                }
              });
            });

            core.setOutput('python_repos', JSON.stringify(python));
            core.setOutput('js_repos', JSON.stringify(js));
            core.setOutput('generic_repos', JSON.stringify(generic));

  extract-python:
    needs: [setup-extraction-matrix]
    if: fromJson(needs.setup-extraction-matrix.outputs.python_repos)[0] != null
    strategy:
      matrix:
        repo: ${{ fromJson(needs.setup-extraction-matrix.outputs.python_repos) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install gettext
        run: sudo apt-get update && sudo apt install -y gettext

      - name: clone repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.organization }}/${{ matrix.repo.actualName }}
          ref: ${{ matrix.repo.ref }}
          path: ${{ matrix.repo.name }}

      - name: Install Python requirements
        run: |
          pip install -r requirements/translations.txt || echo "No global translations.txt, continuing..."

          # FIXED: Install repo-specific requirements for new repos like openedx-wikilearn-features
          if [ -f ${{ matrix.repo.name }}/requirements/base.txt ]; then
            echo "Installing base requirements for ${{ matrix.repo.name }}"
            pip install -r ${{ matrix.repo.name }}/requirements/base.txt
          elif [ -f ${{ matrix.repo.name }}/requirements.txt ]; then
            echo "Installing requirements.txt for ${{ matrix.repo.name }}"
            pip install -r ${{ matrix.repo.name }}/requirements.txt
          fi

          # Special handling for edx-platform
          if [ "${{ matrix.repo.name }}" == "edx-platform" ]; then
            sudo apt install -y libxml2-dev libxmlsec1-dev libxslt1-dev
            pip install -r ${{ matrix.repo.name }}/requirements/edx/base.txt
            # Remove theme directories with locale folders
            rm -rf ${{ matrix.repo.name }}/themes/*/conf 2>/dev/null || true
          fi

      - name: Extract translations
        run: |
          cd ${{ matrix.repo.name }}

          # FIXED: Try make extract_translations first, fallback to django-admin
          if make extract_translations 2>/dev/null; then
            echo "Extraction via make succeeded"
          else
            echo "make extract_translations failed, trying django-admin makemessages"
            django-admin makemessages -l en --verbosity 2
          fi
        env:
          IS_OPENEDX_TRANSLATIONS_WORKFLOW: yes

      - name: Validate compilation
        run: |
          cd ${{ matrix.repo.name }}
          django-admin compilemessages --locale en || echo "Compilation validation skipped"

      - name: Stage extracted files
        run: |
          mkdir -p staging/${{ matrix.repo.name }}
          # FIXED: Use find with -exec to preserve directory structure
          find ${{ matrix.repo.name }} -name "*.po" -type f | while read file; do
            target="staging/$file"
            mkdir -p "$(dirname "$target")"
            cp "$file" "$target"
          done

          # Verify what was staged
          echo "Staged files:"
          find staging/${{ matrix.repo.name }} -name "*.po" | head -20

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: extract-${{ matrix.repo.name }}
          path: staging/
          include-hidden-files: true

  extract-javascript:
    needs: [setup-extraction-matrix]
    if: fromJson(needs.setup-extraction-matrix.outputs.js_repos)[0] != null
    strategy:
      matrix:
        repo: ${{ fromJson(needs.setup-extraction-matrix.outputs.js_repos) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 16

      - name: clone repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.organization }}/${{ matrix.repo.actualName }}
          ref: ${{ matrix.repo.ref }}
          path: ${{ matrix.repo.name }}

      - name: Extract translations
        run: |
          cd ${{ matrix.repo.name }}

          # Try make extract_translations first
          if make extract_translations 2>/dev/null; then
            echo "Extraction via make succeeded"
          else
            echo "make extract_translations failed, trying npm run i18n:extract"
            npm install || true
            npm run i18n:extract || echo "npm i18n:extract also failed"
          fi

      - name: Stage extracted files
        run: |
          mkdir -p staging/${{ matrix.repo.name }}
          # FIXED: Properly copy transifex_input.json with directory structure
          find ${{ matrix.repo.name }} -name "transifex_input.json" -type f | while read file; do
            target="staging/$file"
            mkdir -p "$(dirname "$target")"
            cp "$file" "$target"
          done

          # Verify what was staged
          echo "Staged files:"
          find staging/${{ matrix.repo.name }} -name "transifex_input.json"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: extract-${{ matrix.repo.name }}
          path: staging/
          include-hidden-files: true

  extract-generic:
    needs: [setup-extraction-matrix]
    if: fromJson(needs.setup-extraction-matrix.outputs.generic_repos)[0] != null
    strategy:
      matrix:
        repo: ${{ fromJson(needs.setup-extraction-matrix.outputs.generic_repos) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt install -y gettext

      - name: Install Python requirements
        run: |
          pip install -r requirements/translations.txt || echo "No global translations.txt"

          # FIXED: Install i18n_tool for Tutor themes
          if [ "${{ matrix.repo.extraction_method }}" == "django" ]; then
            echo "Installing i18n_tool for theme extraction"
            pip install i18n_tool
          fi

      - name: clone repo
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo.organization }}/${{ matrix.repo.actualName }}
          ref: ${{ matrix.repo.ref }}
          path: ${{ matrix.repo.name }}

      - name: Extract translations
        run: |
          cd ${{ matrix.repo.name }}

          # FIXED: For Django-style themes, use i18n_tool
          if [ "${{ matrix.repo.extraction_method }}" == "django" ]; then
            echo "Using i18n_tool for theme extraction"
            i18n_tool extract || make extract_translations || django-admin makemessages -l en
          else
            make extract_translations || echo "Extraction failed"
          fi

      - name: Stage extracted files
        run: |
          mkdir -p staging/${{ matrix.repo.name }}

          # FIXED: Handle the transifex_file_path correctly
          source_file="${{ matrix.repo.name }}/${{ matrix.repo.transifex_file_path }}"

          if [ -f "$source_file" ]; then
            target="staging/$source_file"
            mkdir -p "$(dirname "$target")"
            cp "$source_file" "$target"
            echo "Staged: $source_file -> $target"
          else
            echo "WARNING: Source file not found: $source_file"
            echo "Looking for alternative files..."
            find ${{ matrix.repo.name }} -name "*.po" -o -name "*.yaml" -o -name "*.json" | head -10
          fi

          # Verify what was staged
          echo "Staged files:"
          find staging/${{ matrix.repo.name }} -type f

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: extract-${{ matrix.repo.name }}
          path: staging/
          include-hidden-files: true

  # STEP 3 & 4: Logic and Final Merge
  finalize:
    needs: [pull-upstream, extract-python, extract-javascript, extract-generic]
    if: always() # Ensure we merge what we managed to extract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install polib
        run: pip install polib

      - name: Download Upstream
        uses: actions/download-artifact@v4
        with:
          name: translations-upstream
          path: translations-upstream

      - name: Download Extractions
        uses: actions/download-artifact@v4
        with:
          path: extracted-sources
          pattern: extract-*
          merge-multiple: true # This combines all subfolders (edx-platform, etc.) into one root

      - name: Verify downloaded artifacts
        run: |
          echo "=== Upstream Translations ==="
          ls -la translations-upstream/ | head -20
          echo ""
          echo "=== Extracted Sources ==="
          ls -la extracted-sources/ | head -20
          echo ""
          echo "=== Sample extracted files ==="
          find extracted-sources/ -type f | head -20

      - name: STEP 3 Update Custom Layer (Diff & Placeholders)
        run: |
          python3 scripts/wikimedia_workflow_logic.py update_custom --extracted-dir extracted-sources

      - name: STEP 4 Final Production Merge
        run: |
          python3 scripts/wikimedia_workflow_logic.py merge_final

      - name: Verify final output
        run: |
          echo "=== Custom Translations ==="
          find translations-custom/ -type f | head -20 || echo "No custom translations"
          echo ""
          echo "=== Final Translations ==="
          find translations/ -type f | head -20

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.EDX_TRANSIFEX_BOT_GITHUB_TOKEN }}
          commit-message: "feat: unified translation update (Upstream + Custom Override)"
          branch: "chore/unified-translations-${{ github.run_id }}"
          title: "Unified Translation Sync (Atlas Pull + Custom Merge)"
          body: |
            This PR contains the results of the Unified Translation Workflow:
            1. **Step 1**: Upstream pulled from `openedx/openedx-translations` (@${{ inputs.upstream_branch }})
            2. **Step 2**: Custom strings extracted from Forks/New Repos
            3. **Step 3**: Custom strings isolated into `translations-custom/` with automatic placeholders
            4. **Step 4**: Final production bundle generated in `translations/`

            ## Workflow Summary
            - Upstream branch: `${{ inputs.upstream_branch }}`
            - Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          add-paths: |
            translations/
            translations-custom/
            translations-upstream/
